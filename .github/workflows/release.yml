name: Release

on:
  release:
    types: [published]
  workflow_dispatch:

env:
  VERSION: ${{ github.event.release.tag_name || 'latest' }}

jobs:
  build-macos:
    strategy:
      matrix:
        include:
          - runner: macos-latest
            arch: arm64
          - runner: macos-15-intel
            arch: x86_64
    runs-on: ${{ matrix.runner }}
    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies
        run: brew install qt@5 openssl pkg-config

      - name: Build
        run: |
          export PATH="$(brew --prefix qt@5)/bin:$PATH"
          export PKG_CONFIG_PATH="$(brew --prefix openssl)/lib/pkgconfig"
          qmake Qtraktor.pro
          make -j$(sysctl -n hw.ncpu)

      - name: Bundle Qt frameworks
        run: |
          export PATH="$(brew --prefix qt@5)/bin:$PATH"
          macdeployqt Traktor.app

      - name: Archive app (preserve symlinks)
        run: tar -cf Traktor-${{ matrix.arch }}.app.tar Traktor.app

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: Traktor-${{ matrix.arch }}.app
          path: Traktor-${{ matrix.arch }}.app.tar

  package-macos:
    needs: build-macos
    runs-on: macos-latest
    steps:
      - name: Download arm64 app
        uses: actions/download-artifact@v4
        with:
          name: Traktor-arm64.app
          path: arm64

      - name: Download x86_64 app
        uses: actions/download-artifact@v4
        with:
          name: Traktor-x86_64.app
          path: x86_64

      - name: Extract archives
        run: |
          tar -xf arm64/Traktor-arm64.app.tar -C arm64
          tar -xf x86_64/Traktor-x86_64.app.tar -C x86_64

      - name: Create universal binary
        run: |
          cp -R arm64/Traktor.app Universal-Traktor.app

          # Merge all Mach-O binaries with lipo
          find arm64/Traktor.app -type f | while read arm_file; do
            rel="${arm_file#arm64/Traktor.app/}"
            intel_file="x86_64/Traktor.app/$rel"
            universal_file="Universal-Traktor.app/$rel"

            # Check if both files exist and are Mach-O
            if [ -f "$intel_file" ] && file "$arm_file" | grep -q "Mach-O"; then
              echo "Merging: $rel"
              lipo -create "$arm_file" "$intel_file" -output "$universal_file"
            fi
          done

      - name: Codesign universal app
        run: |
          # Sign frameworks and dylibs inside-out before signing the app
          find Universal-Traktor.app/Contents/Frameworks -name "*.framework" -type d | while read fw; do
            codesign --force --sign - "$fw"
          done
          find Universal-Traktor.app/Contents/Frameworks -name "*.dylib" -type f | while read lib; do
            codesign --force --sign - "$lib"
          done
          find Universal-Traktor.app/Contents/PlugIns -type f -name "*.dylib" 2>/dev/null | while read lib; do
            codesign --force --sign - "$lib"
          done
          codesign --force --sign - Universal-Traktor.app

      - name: Create DMG
        run: |
          mv Universal-Traktor.app Traktor.app
          hdiutil create -volname Traktor -srcfolder Traktor.app \
            -ov -format UDZO Traktor-${{ env.VERSION }}.dmg

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: Traktor-${{ env.VERSION }}.dmg
          path: Traktor-${{ env.VERSION }}.dmg

  build-windows:
    runs-on: windows-2022
    steps:
      - uses: actions/checkout@v4

      - name: Install Qt
        uses: jurplel/install-qt-action@v4
        with:
          version: '5.15.2'
          host: windows
          target: desktop
          arch: win64_msvc2019_64
          tools: tools_ifw
          cache: true

      - name: Setup MSVC
        uses: ilammy/msvc-dev-cmd@v1
        with:
          arch: x64

      - name: Cache vcpkg packages
        uses: actions/cache@v4
        with:
          path: C:\vcpkg\installed
          key: vcpkg-windows-${{ hashFiles('.github/workflows/release.yml') }}

      - name: Install OpenSSL and zlib
        run: vcpkg install openssl:x64-windows zlib:x64-windows

      - name: Set vcpkg paths
        shell: pwsh
        run: |
          "OPENSSL_DIR=$env:VCPKG_INSTALLATION_ROOT\installed\x64-windows" | Out-File -FilePath $env:GITHUB_ENV -Append
          "LIB=$env:VCPKG_INSTALLATION_ROOT\installed\x64-windows\lib;$env:LIB" | Out-File -FilePath $env:GITHUB_ENV -Append
          "INCLUDE=$env:VCPKG_INSTALLATION_ROOT\installed\x64-windows\include;$env:INCLUDE" | Out-File -FilePath $env:GITHUB_ENV -Append

      - name: Build
        shell: cmd
        run: |
          qmake Qtraktor.pro
          nmake -f Makefile.Release

      - name: Create installer
        shell: pwsh
        run: |
          # Bundle Qt runtime DLLs
          windeployqt release\Traktor.exe

          # Bundle vcpkg DLLs (OpenSSL + zlib)
          Copy-Item "$env:VCPKG_INSTALLATION_ROOT\installed\x64-windows\bin\libssl*.dll" -Destination release\
          Copy-Item "$env:VCPKG_INSTALLATION_ROOT\installed\x64-windows\bin\libcrypto*.dll" -Destination release\
          Copy-Item "$env:VCPKG_INSTALLATION_ROOT\installed\x64-windows\bin\zlib1.dll" -Destination release\

          # Prepare installer package data
          New-Item -ItemType Directory -Path packages\com.servmask.traktor\data -Force
          Get-ChildItem release | Copy-Item -Destination packages\com.servmask.traktor\data -Recurse

          # Replace version placeholders
          $version = "${{ github.ref_name }}"
          $date = Get-Date -Format yyyy-MM-dd
          (Get-Content "config\config.xml") -replace "develop", $version | Set-Content "config\config.xml"
          (Get-Content "packages\com.servmask.traktor\meta\package.xml") -replace "develop", $version | Set-Content "packages\com.servmask.traktor\meta\package.xml"
          (Get-Content "packages\com.servmask.traktor\meta\package.xml") -replace "release-date", $date | Set-Content "packages\com.servmask.traktor\meta\package.xml"

          # Find and run Qt IFW binarycreator
          $ifw = Get-ChildItem "$env:IQTA_TOOLS\QtInstallerFramework" -Directory | Sort-Object Name -Descending | Select-Object -First 1
          & "$($ifw.FullName)\bin\binarycreator.exe" -c config\config.xml -p packages "Traktor-$env:VERSION.exe"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: Traktor-${{ env.VERSION }}.exe
          path: Traktor-${{ env.VERSION }}.exe

  build-linux:
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y qtbase5-dev qt5-qmake libssl-dev zlib1g-dev pkg-config libfuse2

      - name: Build
        run: |
          qmake Qtraktor.pro
          make -j$(nproc)

      - name: Cache linuxdeploy
        uses: actions/cache@v4
        with:
          path: linuxdeploy*.AppImage
          key: linuxdeploy-continuous

      - name: Create AppImage
        run: |
          # Install linuxdeploy and Qt plugin (skipped if cached)
          [ -f linuxdeploy-x86_64.AppImage ] || wget -q https://github.com/linuxdeploy/linuxdeploy/releases/download/continuous/linuxdeploy-x86_64.AppImage
          [ -f linuxdeploy-plugin-qt-x86_64.AppImage ] || wget -q https://github.com/linuxdeploy/linuxdeploy-plugin-qt/releases/download/continuous/linuxdeploy-plugin-qt-x86_64.AppImage
          chmod +x linuxdeploy*.AppImage

          # Create .desktop file
          cat > traktor.desktop << 'DESKTOP'
          [Desktop Entry]
          Name=Traktor
          Comment=WPRESS Extractor
          Exec=Traktor
          Icon=traktor
          Type=Application
          Categories=Utility;
          DESKTOP
          sed -i 's/^          //' traktor.desktop

          # Build AppImage
          ./linuxdeploy-x86_64.AppImage \
            --appdir AppDir \
            --executable Traktor \
            --desktop-file traktor.desktop \
            --icon-file icons/traktor.png \
            --plugin qt \
            --output appimage

          mv Traktor-*.AppImage Traktor-x86_64-${{ env.VERSION }}.AppImage

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: Traktor-x86_64-${{ env.VERSION }}.AppImage
          path: Traktor-x86_64-${{ env.VERSION }}.AppImage

  upload:
    if: github.event_name == 'release'
    needs: [package-macos, build-windows, build-linux]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4

      - name: Upload assets to GitHub release
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh release upload "${{ github.event.release.tag_name }}" \
            Traktor-${{ env.VERSION }}.dmg/Traktor-${{ env.VERSION }}.dmg \
            Traktor-${{ env.VERSION }}.exe/Traktor-${{ env.VERSION }}.exe \
            Traktor-x86_64-${{ env.VERSION }}.AppImage/Traktor-x86_64-${{ env.VERSION }}.AppImage \
            --repo "${{ github.repository }}"

      - name: Upload to BunnyCDN
        env:
          BUNNY_STORAGE_KEY: ${{ secrets.BUNNY_STORAGE_KEY }}
          BUNNY_STORAGE_ZONE: ${{ secrets.BUNNY_STORAGE_ZONE }}
        run: |
          STORAGE_URL="https://storage.bunnycdn.com/$BUNNY_STORAGE_ZONE"
          FAILED=0

          upload() {
            local remote_name="$1"
            local local_file="$2"
            echo "Uploading $remote_name..."

            response=$(curl -sS --request PUT --url "$STORAGE_URL/$remote_name" \
              --header "AccessKey: $BUNNY_STORAGE_KEY" \
              --upload-file "$local_file" \
              -w "\n%{http_code}")

            http_code=$(echo "$response" | tail -n1)

            if [ "$http_code" -eq 201 ] || [ "$http_code" -eq 200 ]; then
              echo "Uploaded $remote_name"
            else
              body=$(echo "$response" | head -n-1)
              echo "::error::Failed to upload $remote_name (HTTP $http_code): $body"
              FAILED=1
            fi
          }

          # Upload versioned files
          upload "Traktor-${{ env.VERSION }}.dmg" \
            "Traktor-${{ env.VERSION }}.dmg/Traktor-${{ env.VERSION }}.dmg"

          upload "Traktor-${{ env.VERSION }}.exe" \
            "Traktor-${{ env.VERSION }}.exe/Traktor-${{ env.VERSION }}.exe"

          upload "Traktor-x86_64-${{ env.VERSION }}.AppImage" \
            "Traktor-x86_64-${{ env.VERSION }}.AppImage/Traktor-x86_64-${{ env.VERSION }}.AppImage"

          # Upload latest files (stable download links)
          upload "Traktor-latest.dmg" \
            "Traktor-${{ env.VERSION }}.dmg/Traktor-${{ env.VERSION }}.dmg"

          upload "Traktor-latest.exe" \
            "Traktor-${{ env.VERSION }}.exe/Traktor-${{ env.VERSION }}.exe"

          upload "Traktor-x86_64-latest.AppImage" \
            "Traktor-x86_64-${{ env.VERSION }}.AppImage/Traktor-x86_64-${{ env.VERSION }}.AppImage"

          # Upload version.txt (last, so it only updates if uploads succeeded)
          if [ "$FAILED" -eq 0 ]; then
            echo -n "${{ env.VERSION }}" > version.txt
            upload "version.txt" "version.txt"
          fi

          # Track failure but continue
          echo "BUNNY_UPLOAD_FAILED=$FAILED" >> $GITHUB_ENV

      - name: Purge BunnyCDN cache
        run: |
          echo "Purging BunnyCDN cache for PullZone ID: ${{ secrets.BUNNY_PULL_ZONE_ID }}"

          response=$(curl -sS --request POST \
            --url "https://api.bunny.net/pullzone/${{ secrets.BUNNY_PULL_ZONE_ID }}/purgeCache" \
            --header "AccessKey: ${{ secrets.BUNNY_API_KEY }}" \
            -w "\n%{http_code}")

          http_code=$(echo "$response" | tail -n1)
          body=$(echo "$response" | head -n-1)

          if [ "$http_code" -eq 204 ] || [ "$http_code" -eq 200 ]; then
            echo "Cache purge successful"
          else
            echo "::error::Cache purge failed (HTTP $http_code): $body"
          fi

      - name: Check upload results
        if: env.BUNNY_UPLOAD_FAILED == '1'
        run: echo "::warning::One or more BunnyCDN uploads failed"
